<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<title>EtherCalc: 多人即时协作电子表格</title>
<link rel="stylesheet" type="text/css" class="ui" href="./css/semantic.min.css">
<style>
.book { text-align:left;display:block;padding-left:10%;padding-right:10%; }
.book a { text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap; }
.book h2 { text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;font-size:24px;line-height:36px;text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px;  }
.book h3 { text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;line-height:27px;font-size:20px;margin: 18px 0px;  }
.book p {
text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; 
}
.book pre {
background: #F8F8F8;
border: 1px solid #DDDDDD;
border-radius: 3px;
font-size: 18px;
padding: 6px 10px;
line-height: 150%;
}

</style>
</head>
<body>
<meta name="description" content="EtherCalc: 多人即时协作电子表格">

<div class="body" style="vertical-align:bottom;min-height:23155px;text-align:left;font-size:13px;line-height:18px;color:rgb(51, 51, 51);font-family:'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif;padding-top:60px;padding-bottom:40px;overflow-x:visible;overflow-y:visible;margin: 0px; ">
<div style="text-align:left;overflow-x:visible;overflow-y:visible;color:rgb(153, 153, 153);position:absolute;right:0px;left:0px;z-index:1030;margin-bottom:0px;top:0px;">
<div style="text-align:left;background-color: rgb(44, 44, 44); background-size: 100% 105%;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABAAAAAAoCAYAAABgrYjLAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOxAAADsQBlSsOGwAAASdJREFUeJzt29EJgDAQBUEVO7r+a4tVBCE7U0F+89i7Z2ZdAAAAwNHetfz/AQAA4HTP3w8AAAAA9jMAAAAAQIATAAAAAAhQAAAAAECAAgAAAAACFAAAAAAQoAAAAACAAAUAAAAABBgAAAAAIMAJAAAAAAQoAAAAACBAAQAAAAABCgAAAAAIUAAAAABAgAIAAAAAAgwAAAAAEOAEAAAAAAIUAAAAABCgAAAAAIAABQAAAAAEKAAAAAAgQAEAAAAAAQYAAAAACHACAAAAAAEKAAAAAAhQAAAAAECAAgAAAAACFAAAAAAQoAAAAACAAAMAAAAABDgBAAAAgAAFAAAAAAQoAAAAACBAAQAAAAABCgAAAAAIUAAAAABAgAEAAAAAApwAAAAAQMAHE0c01zM+wNUAAAAASUVORK5CYII=);-webkit-box-shadow:rgba(0, 0, 0, 0.246094) 0px 1px 3px, rgba(0, 0, 0, 0.0976562) 0px -1px 0px inset;box-shadow:rgba(0, 0, 0, 0.246094) 0px 1px 3px, rgba(0, 0, 0, 0.0976562) 0px -1px 0px inset;padding-left:0px;padding-right:0px;border-top-left-radius:0px 0px;border-top-right-radius:0px 0px;border-bottom-right-radius:0px 0px;border-bottom-left-radius:0px 0px;background-repeat: repeat-x; ">
<div style="text-align:left;margin-left:auto;margin-right:auto;width:940px;"><span style="display:table;"></span>
<a style="text-decoration:none;font-size:13px;line-height:18px;color:rgb(51, 51, 51);text-align:center;text-shadow:rgba(255, 255, 255, 0.746094) 0px 1px 1px;vertical-align:middle;border-top-left-radius:4px 4px;border-top-right-radius:4px 4px;border-bottom-right-radius:4px 4px;border-bottom-left-radius:4px 4px;cursor:pointer;display:none;float:right;background-color: rgb(44, 44, 44); background-size: 100% 105%;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOxAAADsQBlSsOGwAAABpJREFUWIXtwQEBAAAAgiD/r25IQAEAAADvBhAgAAFHAaCIAAAAAElFTkSuQmCC);-webkit-box-shadow:rgba(255, 255, 255, 0.0976562) 0px 1px 0px inset, rgba(255, 255, 255, 0.0742188) 0px 1px 0px;box-shadow:rgba(255, 255, 255, 0.0976562) 0px 1px 0px inset, rgba(255, 255, 255, 0.0742188) 0px 1px 0px;background-repeat: repeat-x; border-width: 1px; border-style: solid; margin: 5px 5px 0px; padding: 7px 10px; border-color: rgba(0, 0, 0, 0.0976562) rgba(0, 0, 0, 0.0976562) rgba(0, 0, 0, 0.246094); ">
</a>
<div class="ui menu top inverted">
<a class="item" href="#"><i class="icon table"></i>EtherCalc</a>
<a class="item" href="http://www.ethercalc.org/_new" target="_blank"><i class="icon edit"></i>试用</a>
<a class="item" href="#install"><i class="icon terminal"></i>安装</a>
<a class="item" href="#preso"><i class="icon video"></i>演示</a>
<a class="item" href="#preso-en"><i class="icon video"></i>Slides</a>
<a class="item" href="https://github.com/audreyt/ethercalc" target="_blank"><i class="icon github"></i>GitHub</a>
<a class="item" href="#book"><i class="icon fighter jet"></i>系统架构</a>
<a class="item" href="#book2"><i class="icon rocket"></i>性能架构</a>
</div>
<span style="display:table;clear:both;"></span></div>
</div>
</div>
<div style="text-align:left;width:940px;margin-left:auto;margin-right:auto;"><span style="display:table;"></span>
<section style="text-align:left;display:block;">
<div style="text-align:left;margin-bottom:30px;border-top-left-radius:6px 6px;border-top-right-radius:6px 6px;border-bottom-right-radius:6px 6px;border-bottom-left-radius:6px 6px;background-color: rgb(238, 238, 255); padding: 60px; ">
<div style="text-align:left;margin-left:-20px;"><span style="display:table;"></span>
<div style="text-align:left;float:left;margin-left:20px;width:380px;">
<div style="text-align:left;font-size:18px;font-weight:200;line-height:27px;color:inherit;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">
</div><h1 style="text-align:left;font-family:inherit;font-weight:bold;text-rendering:optimizelegibility;font-size:60px;line-height:1;color:inherit;letter-spacing:-1px;display:inline-block;border-top-left-radius:10px 10px;border-top-right-radius:10px 10px;border-bottom-right-radius:10px 10px;border-bottom-left-radius:10px 10px;-webkit-box-shadow:rgb(136, 136, 136) 3px 3px 3px;box-shadow:rgb(136, 136, 136) 3px 3px 3px;background-color: rgb(17, 65, 117); margin: 0px 0px 10px; padding: 10px; "><span style="text-align:left;color:rgb(179, 226, 255);">Ether</span><span style="text-align:left;color:rgb(232, 244, 255);">Calc</span></h1>
<h2 style="text-align:left;color:inherit;text-rendering:optimizelegibility;font-size:24px;line-height:36px;font-weight:normal;font-family:ct5;visibility:visible;margin: 0px 0px 20px; ">即时协作电子表格</h2>
<div style="text-align:left;font-size:18px;font-weight:200;line-height:27px;color:inherit;font-family:ct4;visibility:visible;margin: 0px 0px 9px; ">
您可在网页上建立电子表格，让许多人同时编辑。 </div>
<div style="text-align:left;font-size:18px;font-weight:200;line-height:27px;color:inherit;font-family:ct4;visibility:visible;margin: 0px 0px 9px; ">每次更动都会随时反映在所有人的屏幕上。
</div>
<div style="text-align:left;font-size:18px;font-weight:200;line-height:27px;color:inherit;font-family:ct4;visibility:visible;margin: 0px 0px 9px; ">
现在就来试试看吧！ </div>
</div><div style="text-align:left;float:left;margin-left:20px;width:380px;"><img src="https://ethercalc.org/static/img/davy/gfx/screenshot.png" style="width:456px;text-align:left;height:auto;vertical-align:middle;max-width:120%;border-top-left-radius:10px 10px;border-top-right-radius:10px 10px;border-bottom-right-radius:10px 10px;border-bottom-left-radius:10px 10px;-webkit-box-shadow:rgb(136, 136, 136) 5px 5px 3px;box-shadow:rgb(136, 136, 136) 5px 5px 3px;border-width: 0px; border-style: none; border-color: white; "></div>
<span style="display:table;clear:both;"></span></div>
<div style="text-align:left;font-size:18px;font-weight:200;line-height:27px;color:inherit;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><a href="http://www.ethercalc.org/_new" target="_blank" style="text-decoration:none;display:inline-block;margin-bottom:0px;text-align:center;vertical-align:middle;cursor:pointer;font-size:15px;line-height:normal;border-top-left-radius:5px 5px;border-top-right-radius:5px 5px;border-bottom-right-radius:5px 5px;border-bottom-left-radius:5px 5px;text-shadow:rgba(0, 0, 0, 0.246094) 0px -1px 0px;color:rgb(255, 255, 255);background-color: rgb(0, 116, 204); background-size: 100% 105%;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEoAAAASCAYAAAD8DUjrAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOxAAADsQBlSsOGwAAAFBJREFUWIXt1dsJADAIxVAL7t7lulIfIzR/IuRMIOGCI+a6oa+MXX1CD4aCDAUZCjIUlHGqT+jBRUGGggwFGQoyFOTXg1wUZCjIUJChIENBD8m9E2cLZupwAAAAAElFTkSuQmCC);-webkit-box-shadow:rgb(136, 136, 136) 2px 2px 3px;box-shadow:rgb(136, 136, 136) 2px 2px 3px;font-family:ct4;visibility:visible;background-repeat: repeat-x; border-width: 1px; border-style: solid; padding: 9px 14px; border-color: rgba(0, 0, 0, 0.0976562) rgba(0, 0, 0, 0.0976562) rgba(0, 0, 0, 0.246094); ">在线试用 »</a></div>
<a target="_blank" href="https://ethercalc.org/privacy.png">Terms of Service &amp; Privacy Policy</a>
</div>
<section style="text-align:left;display:block;padding-left:10%;padding-right:10%;">
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h1 id="install" style="text-align:left;font-family:inherit;color:inherit;text-rendering:optimizelegibility;font-size:30px;line-height:1;font-weight:normal;margin: 0px; ">安装</h1>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><strong style="text-align:left;font-weight:bold;">EtherCalc</strong>
是自由软件，可在 GNU/Linux、FreeBSD、Mac OS X 和 Windows 上运行。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">请先下载并安装
<a href="http://nodejs.org/#download" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">Node.js</a>，再输入以下指令即可：
</div><pre style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;color:rgb(51, 51, 51);display:block;background-color: rgb(245, 245, 245); border-top-left-radius:4px 4px;border-top-right-radius:4px 4px;border-bottom-right-radius:4px 4px;border-bottom-left-radius:4px 4px;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;font-size:16px;line-height:150%;border-width: 1px; border-style: solid; margin: 0px 0px 9px; padding: 8.5px; border-color: rgba(0, 0, 0, 0.148438); ">npm install ethercalc
./node_modules/ethercalc/bin/ethercalc
</pre>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">
想要安装给所有使用者时，也可以使用 <code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">sudo</code>
加上 <code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">npm install -g</code>
参数来安装： </div>
<pre style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;color:rgb(51, 51, 51);display:block;background-color: rgb(245, 245, 245); border-top-left-radius:4px 4px;border-top-right-radius:4px 4px;border-bottom-right-radius:4px 4px;border-bottom-left-radius:4px 4px;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;font-size:16px;line-height:150%;border-width: 1px; border-style: solid; margin: 0px 0px 9px; padding: 8.5px; border-color: rgba(0, 0, 0, 0.148438); ">npm install -g ethercalc
ethercalc
</pre>
<div style="text-align:left;font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:20px;line-height:150%;padding-bottom:10px;margin: 0px 0px 9px; "></div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">如果本机上有
<a href="http://redis.io/" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">Redis</a>
服务器正在运行，EtherCalc 会优先使用它来存储资料，以增进性能。</div>
<p style="font-size: 17px; line-height: 150%">在 <a target="_blank" href="https://sandstorm.io/">Sandstorm</a> 平台的安装指南，请参考<a target="_blank" href="https://alpha.sandstorm.io/grain/FTjc4i2dk7hgmChi3L7eKB">这份文件</a>。此外，您也可以使用预先建置好的 <a target="_blank" href="https://registry.hub.docker.com/u/audreyt/ethercalc/">Docker</a> 套件。
</p>
</section>
<div style="float: right; width:425px; margin-left: 10px" id="__ss_12539343"> <strong style="display:block;margin:12px 0 4px"><a href="https://www.slideshare.net/autang/ethercalc-the-video" title="EtherCalc: The Video" target="_blank">EtherCalc: The Video - 中文</a></strong> <iframe src="12539343.htm" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" height="355" width="425"></iframe></div>
<section style="text-align:left;display:block;padding-left:10%;padding-right:10%;">
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h1 id="preso" style="text-align:left;font-family:inherit;color:inherit;text-rendering:optimizelegibility;font-size:30px;line-height:1;font-weight:normal;margin: 0px; ">演示文稿</h1>
</div>
<ul style="text-align:left;list-style: disc outside none; margin: 0px 0px 9px 25px; padding: 0px; ">
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;"><a href="https://ethercalc.tw/ethercalc.key" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">下载 Keynote 演示文稿</a>
(15MB)</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;"><a href="https://ethercalc.tw/ethercalc.mov" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">下载 QuickTime 视频</a>
(58MB)</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;"><a href="https://ethercalc.tw/ethercalc.pdf" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">下载 PDF 演示文稿</a>
(20MB)</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;"><a href="https://www.slideshare.net/autang/ethercalc" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">在线浏览 PDF 演示文稿</a>
(SlideShare)</li>
</ul>
</section>
<section style="text-align:left;display:block;padding-left:10%;padding-right:10%;">
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h1 id="preso-en" style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;font-size:30px;line-height:1;margin: 0px; ">Slides</h1>
</div>
<ul style="text-align:left;list-style: disc outside none; margin: 0px 0px 9px 25px; padding: 0px; ">
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;"><a href="https://ethercalc.tw/ethercalc-en.key" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">Download Keynote slides</a>
(15MB)</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;"><a href="https://ethercalc.tw/ethercalc-en.odp" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">Download OpenDocument slides</a>
(15MB)</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;"><a href="https://ethercalc.tw/ethercalc-en.pdf" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">Download PDF slides</a>
(20MB)</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;"><a href="https://www.slideshare.net/autang/ethercalc-multiplayer-spreadsheet-12641848" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">View PDF slides online</a>
(SlideShare)</li>
</ul>
</section>
<section style="text-align:left;display:block;padding-left:10%;padding-right:10%;">
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h1 id="book" style="text-align:left;font-family:inherit;color:inherit;text-rendering:optimizelegibility;font-size:30px;line-height:1;font-weight:normal;margin: 0px; ">系统架构</h1>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">
以下是<a href="http://aosabook.org/" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">《开源应用程序架构》</a>SocialCalc 章节的中文译本，全文采用
<a style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">CC0 条款</a>，属于公众领域。
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">
如果您愿意<a href="http://www.aosabook.org/en/index.html#purchase" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">购买本书</a>，作者的全部版税将捐赠给<a href="http://amnesty.org/" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">国际特赦组织</a>。
</div>
</section>
<section style="text-align:left;display:block;padding-left:10%;padding-right:10%;">
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h2 id="ch1" style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;font-size:24px;line-height:36px;margin: 0px; ">缘起</h2>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">电子表格的应用历史，已经超过 30 年了。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">第一个电子表格程序 VisiCalc 是由 Dan Bricklin 在 1978 年着手开发，于 1979 年问世。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">最初的设计非常直接了当：可以在两个维度上任意扩展的表格，其中每个存储格可以存放文字、数字，以及公式。公式由普通的数学计算操作以及各种内建函数组成，并能使用其他存储格的值作为参数。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">电子表格的理念看似简单，但却可应用于各种不同的实务领域：会计、库存清单、建模预测、列表管理... 不同用法有着几乎无限的可能性。这些应用使得 VisiCalc 成为第一款个人电脑领域里的“杀手级程序”。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">在随后的几十年里，虽然 Lotus 1-2-3 及 Excel 等后继者提出了各种改进，但核心原理都是相同的；大部分电子表格都以硬盘文件的形式保存，并在打开或编辑时读入内存。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">在基于文件的模式下，协作显得异常困难，主要难点体现在：</div>
<ul style="text-align:left;list-style: disc outside none; margin: 0px 0px 9px 25px; padding: 0px; ">
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">每位使用者都需要安装特定版本的电子表格编辑器。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">电子邮件往来、共享文件夹，或安装一套专用的版本控制系统，都会增加额外的管理成本。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">变动追踪功能非常有限；举例来说，Excel 无法对格式和单元格注释内容的变动保留历史记录。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">更新模板中的格式或公式后，还需对使用该公式的所有电子表格文件进行更繁琐的手工更新。</li>
</ul>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">好在一种新的协作模式出现了，可以用非常简单的方式解决这些问题。这就是<strong style="text-align:left;font-weight:bold;">Wiki</strong>模式，由 Ward Cunningham 于 1994 年开发，并由维基百科在 21 世纪前期使其广为人知。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">与文件模式不同，Wiki模式以保存在服务器上的<strong style="text-align:left;font-weight:bold;">页面</strong>为基础，不需要任何额外的软件即可在浏览器中编辑。这些超文本页面可以直接相互链接，甚至可以包含某个大型页面中的部分内容。预设情况下，所有参与者都可查看并编辑<strong style="text-align:left;font-weight:bold;">最新版本</strong>，并可在服务器上自动保存版本修订的历史纪录。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">受到Wiki模式的启发，Dan Bricklin 从 2005 年开始着手开发&nbsp;<strong style="text-align:left;font-weight:bold;">wikiCalc</strong>。它结合了Wiki系统的易于创建、多人编辑等特性，而仍然保有电子表格系统中常用的视觉格式和计算理念。</div>
</section>
<section style="text-align:left;display:block;padding-left:10%;padding-right:10%;">
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h2 id="ch2" style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;font-size:24px;line-height:36px;margin: 0px; ">WikiCalc</h2>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">WikiCalc 一问世就带来许多独特的功能，是同时期的电子表格所没有的：</div>
<ul style="text-align:left;list-style: disc outside none; margin: 0px 0px 9px 25px; padding: 0px; ">
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">纯文字、HTML，以及Wiki式的文本标记支持。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">Wiki文字包含插入链接、图片，以及和从存储格引用值的功能。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">公式存储格可以引用放在其他网站的 WikiCalc 网页里的值。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">支持输出到静态网页，以及将动态资料内嵌至其他网页。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">存储格能使用 CSS 来改变样式。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">记录所有编辑操作，以供稽核纪录。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">和Wiki系统一样，保留每一个版本，并可以随时回复。</li>
</ul>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">从几个小型电子表格组建一个<strong style="text-align:left;font-weight:bold;">主电子表格</strong>的能力，是 WikiCalc 的一大强项。举例来说，每位销售员可以把营业额放在自己的电子表格页面里；然后销售经理可以综合这些资料到该区的电子表格中，之后销售副总再综合各区域的数字，构成主电子表格。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">每
次有电子表格更新时，所有综合它的电子表格都会即时反映出这次更新。如果主电子表格的读者想要瞭解更多细节，只需要点击链结，即可查看电子表格后面的电子
表格。这项功能让使用者不再需要在多个地方更新数字，从而减少了多余而容易出错的操作，并确保所有信息的视图总在最新状态。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="wikicalc-components.png" style="width:443px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">为了即时重新计算的需求，WikiCalc 采用了<strong style="text-align:left;font-weight:bold;">轻客户端</strong>的设计，将所有要显示的信息都放在服务器端。每个电子表格在浏览器上以&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">&lt;table&gt;</code>&nbsp;元素呈现；编辑存储格时，浏览器会发送一个&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">ajaxsetcell</code>&nbsp;指令到服务器，然后服务器告诉浏览器哪个存储格需要更新。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="wikicalc-flow.png" style="width:438px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">当然，这项设计依赖于浏览器与服务器之间的快速连接。当网络出现延迟的时候，使用者在更新存储格和看到它的新内容之间，会看到&nbsp;<em style="text-align:left;font-style:italic;">Loading...</em>&nbsp;讯息频繁出现；这问题对于需要即时调整、预览公式结果的使用者特别严重。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="wikicalc-loading.png" style="width:353px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">此外，因为&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">&lt;table&gt;</code>&nbsp;元素与电子表格有着相同大小，一个 100x100 电子表格会在 DOM 里创建上万个&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">&lt;td&gt;</code>&nbsp;元素，大量消耗浏览器的内存资源，进一步限制页面的大小。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">由于这些缺点，虽然 WikiCalc 作为在本地主机运行的独立服务器时尚称实用，但要当作网页内容管理系统的一部分，却超出了它的能力。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">在
 2006 年，Dan Bricklin 与 Socialtext 团队开始开发 SocialCalc 项目，用 JavaScript 语言对 
WikiCalc 原本的 Perl 源代码作出改写，目标是能支持大型电子表格、分布式协作流程，以及与桌面应用程序一样的操作界面。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">这里是 SocialCalc 的一些设计目标：</div>
<ul style="text-align:left;list-style: disc outside none; margin: 0px 0px 9px 25px; padding: 0px; ">
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">处理十万个存储格的能力。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">进行编辑操作时提供快速响应。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">客户端的稽核纪录和还原/重作支持。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">善用 JavaScript 和 CSS ，提供完整的视觉呈现功能。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">用 JavaScript 提升性能，并加强对各种不同浏览器的支持。</li>
</ul>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">经过三年的开发和发布许多次测试版之后，Socialtext 在 2009 年发布 SocialCalc 1.0，成功实现了设计目标。现在，让我们来看看 SocialCalc 的系统架构。</div>
</section>
<section style="text-align:left;display:block;padding-left:10%;padding-right:10%;">
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h2 id="ch3" style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;font-size:24px;line-height:36px;margin: 0px; ">SocialCalc</h2>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">这是 SocialCalc 在运行过程中的画面：</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="socialcalc-screenshot.png" style="width:427px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">底下则是它的类型图：</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="socialcalc-class-diagram.png" style="width:500px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">相较于 WikiCalc，服务器的角色已大幅减轻。现在服务器只需要负责响应 HTTP GET 请求，提供整份表格内容的序列化字串即可。浏览器在收到资料后，所有计算、变动追踪，以及使用者的互动都是通过 JavaScript 达成的。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">JavaScript 元件在设计上使用了层次式 MVC（模型/视图/控制器）样式，每个类型都只专注于某部分的功能：</div>
<ul style="text-align:left;list-style: disc outside none; margin: 0px 0px 9px 25px; padding: 0px; ">
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;"><strong style="text-align:left;font-weight:bold;">Sheet</strong>&nbsp;是资料模型，代表电子表格在内存中的结构。&nbsp;
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">模型中包含从坐标指向&nbsp;<strong style="text-align:left;font-weight:bold;">Cell</strong>&nbsp;对象的字典，每个对象代表一个存储格。空存储格所在的坐标不需要有对应的对象，因此完全不占用内存。</div>
</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;"><strong style="text-align:left;font-weight:bold;">Cell</strong>&nbsp;代表存储格的内容和格式。&nbsp;
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">下面列出的是一些常见的&nbsp;<strong style="text-align:left;font-weight:bold;">Cell</strong>&nbsp;对象属性：</div>
<pre style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;color:rgb(51, 51, 51);display:block;background-color: rgb(245, 245, 245); border-top-left-radius:4px 4px;border-top-right-radius:4px 4px;border-bottom-right-radius:4px 4px;border-bottom-left-radius:4px 4px;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;font-size:16px;line-height:150%;border-width: 1px; border-style: solid; margin: 0px 0px 9px; padding: 8.5px; border-color: rgba(0, 0, 0, 0.148438); ">    datatype    t
    datavalue   1Q84
    color       black
    bgcolor     white
    font        italic bold 12pt Ubuntu
    comment     Ichi-Kyu-Hachi-Yon</pre>
</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;"><strong style="text-align:left;font-weight:bold;">RenderContext</strong>&nbsp;用于实现视图，需要负责将表格绘制为相应的 DOM 对象。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;"><strong style="text-align:left;font-weight:bold;">TableControl</strong>&nbsp;则是主控制器，负责接收鼠标和键盘事件。&nbsp;
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">在接收到视图事件，例如滚动和调整大小后，就会对相关&nbsp;<strong style="text-align:left;font-weight:bold;">RenderContext</strong>&nbsp;对象进行更新。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">如果收到应用于电子表格内容的更新事件，则会在电子表格的指令队列中加入新的指令。</div>
</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;"><strong style="text-align:left;font-weight:bold;">SpreadSheetControl</strong>&nbsp;负责绘制顶层界面，包括工具栏、状态栏、对话框，以及颜色选择器。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;"><strong style="text-align:left;font-weight:bold;">SpreadSheetViewer</strong>&nbsp;是另一套顶层界面，主要提供只读的互动视图。</li>
</ul>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">我们采用了基于类型的轻量级对象系统，仅使用了简单的组成/委派机制，完全没有使用继承或对象原型。所有符号都位于&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">SocialCalc.*</code>&nbsp;命名空间里，以避免命名冲突。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">对电子表格的全部更新都需要通过&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">ScheduleSheetCommands</code>&nbsp;方法进行，因此需要通过指令字串来代表编辑操作。常用的指令如下：</div>
<pre style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;color:rgb(51, 51, 51);display:block;background-color: rgb(245, 245, 245); border-top-left-radius:4px 4px;border-top-right-radius:4px 4px;border-bottom-right-radius:4px 4px;border-bottom-left-radius:4px 4px;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;font-size:16px;line-height:150%;border-width: 1px; border-style: solid; margin: 0px 0px 9px; padding: 8.5px; border-color: rgba(0, 0, 0, 0.148438); ">    set     sheet defaultcolor blue
    set     A width 100
    set     A1 value n 42
    set     A2 text t Hello
    set     A3 formula A1*2
    set     A4 empty
    set     A5 bgcolor green
    merge   A1:B2
    unmerge A1
    erase   A2
    cut     A3
    paste   A4
    copy    A5
    sort    A1:B9 A up B down
    name    define Foo A1:A5
    name    desc   Foo Used in formulas like SUM(Foo)
    name    delete Foo
    startcmdextension UserDefined args</pre>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">任何想要嵌入 SocialCalc 的应用程序，都可以自行定义额外的指令，只需要将命名的回调函数添加到&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">SocialCalc.​SheetCommandInfo.​CmdExtensionCallbacks</code>&nbsp;对象，即可使用&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">startcmdextension</code>&nbsp;指令进行呼叫。</div>
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h3 style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;line-height:27px;font-size:20px;margin: 0px; ">指令的循环运行</h3>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">为改善响应速度，SocialCalc 会在后台执行全部的重算和 DOM 更新，因此在使用者对多个存储格进行修改时，电子表格引擎会同时在指令队列里处理先前的改动。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">在运行指令时，<strong style="text-align:left;font-weight:bold;">TableEditor</strong>&nbsp;对象会将其&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">busy</code>&nbsp;属性设为&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">true</code>；后续指令则需加入到&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">deferredCommands</code>&nbsp;队列，以确保指令能循序执行。事件循环看起来像这样：</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="socialcalc-command-runloop.png" style="width:500px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">如上图所示，<strong style="text-align:left;font-weight:bold;">Sheet</strong>&nbsp;对象会持续发送&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">StatusCallback</code>&nbsp;事件，以提醒使用者当前的指令执行状态。这一过程可以分为下列四个步骤：</div>
<ul style="text-align:left;list-style: disc outside none; margin: 0px 0px 9px 25px; padding: 0px; ">
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">执行指令&nbsp;
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">启动时发送&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">cmdstart</code>，执行完成后则发送&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">cmdend</code>。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">如果指令间接更改了某存储格的值，则进入<strong style="text-align:left;font-weight:bold;">重算</strong>步骤。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">否则，如果指令更改了一个或多个已在屏幕上显示的存储格的视觉外观，则进入<strong style="text-align:left;font-weight:bold;">绘制</strong>步骤。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">如果上述情况都不符合（例如在使用<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">copy</code>指令时），则跳到<strong style="text-align:left;font-weight:bold;">位置计算</strong>步骤。</div>
</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">重算（如果需要的话）&nbsp;
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">启动时发送&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">calcstart</code>，在检查存储格的依存链时每隔 100ms 发送&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">calcorder</code>，完成检查时则发送&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">calccheckdone</code>，并在所有受影响存储格获得重算后的值后发送&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">calcfinished</code>。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">这一步骤之后总是需要执行<strong style="text-align:left;font-weight:bold;">绘制</strong>步骤。</div>
</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">绘制（如果需要的话）&nbsp;
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">启动时发送&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">schedrender</code>，如果使用格式化后的存储格更新了&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">&lt;table&gt;</code>&nbsp;DOM 对象，则发送&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">renderdone</code>。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">这一步骤之后总是需要执行<strong style="text-align:left;font-weight:bold;">位置计算</strong>步骤。</div>
</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">位置计算&nbsp;
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">启动时发送&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">schedposcalc</code>，并在更新了滚动条、<strong style="text-align:left;font-weight:bold;">目前存储格</strong>游标，以及&nbsp;<strong style="text-align:left;font-weight:bold;">TableEditor</strong>&nbsp;的其他视觉组件后发送&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">doneposcalc</code>。</div>
</li>
</ul>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">因为所有指令在执行后即被保存，因此等于对所有操作都可获得<strong style="text-align:left;font-weight:bold;">执行纪录</strong>。为实现稽核追踪，<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">Sheet.CreateAuditString</code>&nbsp;方法会传回以换行隔开的字符串，每行内容对应到一个指令的相关记录。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">ExecuteSheetCommand</code>&nbsp;还可为执行的每个指令创建<strong style="text-align:left;font-weight:bold;">还原指令</strong>。举例来说，如果存储格 A1 包含&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">Foo</code>，而使用者执行了&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">set A1 text Bar</code>，则还原指令<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">set A1 text Foo</code>&nbsp;会被推送到&nbsp;<strong style="text-align:left;font-weight:bold;">UndoStack</strong>&nbsp;里。如果使用者进行还原操作，则会通过执行还原指令来让 A1 的内容回到原先的值。</div>
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h3 style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;line-height:27px;font-size:20px;margin: 0px; ">电子表格编辑器</h3>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">接着一起来看看&nbsp;<strong style="text-align:left;font-weight:bold;">TableEditor</strong>&nbsp;层。该层可计算&nbsp;<strong style="text-align:left;font-weight:bold;">RenderContext</strong>&nbsp;的屏幕显示内容，并通过两个&nbsp;<strong style="text-align:left;font-weight:bold;">TableControl</strong>&nbsp;实例来管理水平/垂直卷动轴。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="socialcalc-parts.png" style="width:402px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">视图层主要由&nbsp;<strong style="text-align:left;font-weight:bold;">RenderContext</strong>&nbsp;类型负责。与 WikiCalc 的设计不同的是，我们并非将每个存储格对应到一个&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">&lt;td&gt;</code>&nbsp;元素，而是直接创建固定大小的&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">&lt;table&gt;</code>，使它充分填满浏览器的可视区域，并为其预先填充&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">&lt;td&gt;</code>&nbsp;元素。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">当使用者通过自定义的滚动条拖动电子表格后，可以动态更新预先绘制的&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">&lt;td&gt;</code>&nbsp;元素的&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">innerHTML</code>。这意味着在很多常见情况下，我们并不需要创建/删除任何&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">&lt;tr&gt;</code>&nbsp;或&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">&lt;td&gt;</code>&nbsp;元素，因此大幅提升了响应速度。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">因为&nbsp;<strong style="text-align:left;font-weight:bold;">RenderContext</strong>&nbsp;只绘制可视区域，所以无论电子表格多大，执行性能也不受影响。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><strong style="text-align:left;font-weight:bold;">TableEditor</strong>&nbsp;还包含一个&nbsp;<strong style="text-align:left;font-weight:bold;">CellHandles</strong>&nbsp;对象，可用于处理附加到<strong style="text-align:left;font-weight:bold;">目前存储格</strong>（即ECell）右下角的圆盘形填充/移动/滑动选单指令：</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="socialcalc-cell-handles.png" style="width:243px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">输入框则由两个类型负责管理：<strong style="text-align:left;font-weight:bold;">InputBox</strong>&nbsp;和&nbsp;<strong style="text-align:left;font-weight:bold;">InputEcho</strong>。前者主要管理网格上的编辑行，后者主要用于在输入内容时提供及时更新的预览层，并覆盖ECell的内容。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="socialcalc-input.png" style="width:434px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">通常，SocialCalc 引擎只有在打开电子表格并进行编辑时，以及将内容保存回服务器时才需要与服务器通信。因此，<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">Sheet.ParseSheetSave</code>&nbsp;方法可在<strong style="text-align:left;font-weight:bold;">Sheet</strong>&nbsp;对象中解析<strong style="text-align:left;font-weight:bold;">存储格式</strong>字串，而&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">Sheet.CreateSheetSave</code>&nbsp;方法可将&nbsp;<strong style="text-align:left;font-weight:bold;">Sheet</strong>&nbsp;对象序列化为存储格式。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">通过使用 URL，公式可引用任何远端电子表格中的值。<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">recalc</code>&nbsp;指令会重新抓取被引用的外部电子电子表格，并使用&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">Sheet.ParseSheetSave</code>&nbsp;对其进行解析，然后将其存储在暂存区中，这样使用者即可在不重新抓取内容的情况下，直接引用相同远端表格中其他存储格的内容。</div>
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h3 style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;line-height:27px;font-size:20px;margin: 0px; ">存储格式</h3>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">存储格式是一种标准的 MIME&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">multipart/mixed</code>&nbsp;格式，主要由四个&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">text/plain; charset=UTF-8</code>&nbsp;部件组成，每部件包含以换行隔开的文字，并用冒号划分资料栏位。这些部件包括：</div>
<ul style="text-align:left;list-style: disc outside none; margin: 0px 0px 9px 25px; padding: 0px; ">
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;"><code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">meta</code>&nbsp;部件列出其他部件的型别。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;"><code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">sheet</code>&nbsp;部件列出每个存储格的格式和功能、每个列的宽度（如果不是预设宽度）、表格的预设格式，以及该电子表格中用到的字体、颜色，及边框列表。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">可选的&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">edit</code>&nbsp;部件可保存&nbsp;<strong style="text-align:left;font-weight:bold;">TableEditor</strong>&nbsp;的编辑状态，包括 ECell 的最后一个位置，以及行/列窗格的固定大小。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">可选的&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">audit</code>&nbsp;部件包含上一次编辑会话中执行过的指令历史记录。</li>
</ul>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">举例来说，下面是一个包含三个存储格的电子表格，A1 作为 ECell，其内容为&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">1874</code>，A2 中是公式&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">2^2*43</code>，A3 中的公式&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">SUM(Foo)</code>&nbsp;则显示为粗体字，代表命名范围从&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">Foo</code>&nbsp;到&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">A1:A2</code>：</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="socialcalc-2046.png" style="width:303px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">这份电子表格经过序列化后，存储格式会像这样：</div>
<pre style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;color:rgb(51, 51, 51);display:block;background-color: rgb(245, 245, 245); border-top-left-radius:4px 4px;border-top-right-radius:4px 4px;border-bottom-right-radius:4px 4px;border-bottom-left-radius:4px 4px;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;font-size:16px;line-height:150%;border-width: 1px; border-style: solid; margin: 0px 0px 9px; padding: 8.5px; border-color: rgba(0, 0, 0, 0.148438); ">    socialcalc:version:1.0
    MIME-Version: 1.0
    Content-Type: multipart/mixed; boundary=SocialCalcSpreadsheetControlSave
    --SocialCalcSpreadsheetControlSave
    Content-type: text/plain; charset=UTF-8

    # SocialCalc Spreadsheet Control Save
    version:1.0
    part:sheet
    part:edit
    part:audit
    --SocialCalcSpreadsheetControlSave
    Content-type: text/plain; charset=UTF-8

    version:1.5
    cell:A1:v:1874
    cell:A2:vtf:n:172:2^2*43
    cell:A3:vtf:n:2046:SUM(Foo):f:1
    sheet:c:1:r:3
    font:1:normal bold * *
    name:FOO::A1\cA2
    --SocialCalcSpreadsheetControlSave
    Content-type: text/plain; charset=UTF-8

    version:1.0
    rowpane:0:1:14
    colpane:0:1:16
    ecell:A1
    --SocialCalcSpreadsheetControlSave
    Content-type: text/plain; charset=UTF-8

    set A1 value n 1874
    set A2 formula 2^2*43
    name define Foo A1:A2
    set A3 formula SUM(Foo)
    --SocialCalcSpreadsheetControlSave--</pre>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">上述格式在设计上可让人直接读取，并且也很容易通过程序生成。因此，Drupal 项目的 Sheetnode 插件即可使用 PHP 在此格式以及其他流行的电子表格格式，例如 Excel (<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">.xls</code>) 及 OpenDocument (<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">.ods</code>) 之间进行转换。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">至此，我们已经简要介绍了 SocialCalc 各个元件和组成方式。接下来，让我们透过两个实际的范例，一起来看看如何扩展 SocialCalc 的功能。</div>
</section>
<section style="text-align:left;display:block;padding-left:10%;padding-right:10%;">
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h2 id="ch4" style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;font-size:24px;line-height:36px;margin: 0px; ">富文本编辑</h2>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">我们对 SocialCalc 所做的第一项改进，是让文字存储格能够使用Wiki语法，以及直接在表格编辑器中实现的富文本绘制：</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="richtext-screenshot.png" style="width:365px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">在 1.0 版发布之后不久，为了响应用户希望通过统一语法插入图片、链接，以及文字标记的需求，我们帮 SocialCalc 加上了这项功能。由于 Socialtext 提供自己的开源Wiki平台，因此自然会希望能在电子表格中直接使用相同的语法。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">为了实现此功能，我们需要将预设的文字存储格格式（即&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">textvalueformat</code>&nbsp;属性）设为&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">text-wiki</code>，并为它提供自定的绘制器。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">至于&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">textvalueformat</code>&nbsp;属性是什么呢？请见下文。</div>
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h3 style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;line-height:27px;font-size:20px;margin: 0px; ">类型与格式</h3>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">在 SocialCalc 中，每个存储格都有一个&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">datatype</code>&nbsp;及一个&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">valuetype</code>&nbsp;属性。包含文字/数字资料的存储格分别对应到文字/数字值类型，而具备&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">datatype="f"</code>&nbsp;的公式存储格则可能会生成数字或文字值。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">在前一节介绍的<strong style="text-align:left;font-weight:bold;">绘制</strong>步骤中，<strong style="text-align:left;font-weight:bold;">Sheet</strong>&nbsp;对象会为每个存储格生成 HTML。为此，它会检查每个存储格的&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">valuetype</code>：如果以&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">t</code>&nbsp;开头，则该存储格的<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">textvalueformat</code>&nbsp;属性会决定如何进行生成。如果以&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">n</code>&nbsp;开头，则使用&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">nontextvalueformat</code>&nbsp;属性进行判断。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">如果该存储格的&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">textvalueformat</code>&nbsp;或&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">nontextvalueformat</code>&nbsp;属性没有定义，则会通过其&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">valuetype</code>&nbsp;属性查询预设格式，如下图所示：</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="richtext-formats.png" style="width:486px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">对&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">text-wiki</code>&nbsp;值格式的支持，写在&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">SocialCalc.​format_text_for_display</code>&nbsp;中：</div>
<pre style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;color:rgb(51, 51, 51);display:block;background-color: rgb(245, 245, 245); border-top-left-radius:4px 4px;border-top-right-radius:4px 4px;border-bottom-right-radius:4px 4px;border-bottom-left-radius:4px 4px;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;font-size:16px;line-height:150%;border-width: 1px; border-style: solid; margin: 0px 0px 9px; padding: 8.5px; border-color: rgba(0, 0, 0, 0.148438); ">     if (SocialCalc.Callbacks.expand_wiki
         &amp;&amp; /^text-wiki/.test(valueformat)
     ) { 
         // do general wiki markup 
         displayvalue = SocialCalc.Callbacks.expand_wiki(
             displayvalue, sheetobj, linkstyle, valueformat
         ); 
     } </pre>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">此处我们并非将“Wiki文字转 HTML”的转换器嵌入到&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">format_text_for_display</code>&nbsp;里，而是在&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">SocialCalc.​Callbacks</code>&nbsp;里定义一个新的挂钩。这是 SocialCalc 代码里推荐的方法：这种模组化的设计，让应用程序可以支持各种不同Wiki文字的语法。如果应用程序用不到&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">text-wiki</code>&nbsp;格式，也可以直接忽略&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">expand_wiki</code>&nbsp;挂钩。</div>
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h3 style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;line-height:27px;font-size:20px;margin: 0px; ">绘制Wiki文字</h3>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">随后，我们使用了&nbsp;<a href="https://github.com/audreyt/wikiwyg-js" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">Wikiwyg</a>，这是一个 JavaScript 程序库，可在Wiki文字和 HTML 之间提供双向转换。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">我们定义下列&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">expand_wiki</code>&nbsp;函数，将存储格的值透过 Wikiwyg 的&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">Wikitext</code>&nbsp;解析器和&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">HTML</code>&nbsp;产生器转换成 HTML：</div>
<pre style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;color:rgb(51, 51, 51);display:block;background-color: rgb(245, 245, 245); border-top-left-radius:4px 4px;border-top-right-radius:4px 4px;border-bottom-right-radius:4px 4px;border-bottom-left-radius:4px 4px;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;font-size:16px;line-height:150%;border-width: 1px; border-style: solid; margin: 0px 0px 9px; padding: 8.5px; border-color: rgba(0, 0, 0, 0.148438); ">     var parser = new Document.Parser.Wikitext(); 
     var emitter = new Document.Emitter.HTML(); 
     SocialCalc.Callbacks.expand_wiki = function(val) { 
         // Convert val from Wikitext to HTML 
         return parser.parse(val, emitter); 
     } </pre>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">最后一个步骤则需要在电子表格初始化完毕后，将&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">set sheet defaulttextvalueformat text-wiki</code>&nbsp;加入命令队列：</div>
<pre style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;color:rgb(51, 51, 51);display:block;background-color: rgb(245, 245, 245); border-top-left-radius:4px 4px;border-top-right-radius:4px 4px;border-bottom-right-radius:4px 4px;border-bottom-left-radius:4px 4px;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;font-size:16px;line-height:150%;border-width: 1px; border-style: solid; margin: 0px 0px 9px; padding: 8.5px; border-color: rgba(0, 0, 0, 0.148438); ">     // Assume there's a &lt;div id="tableeditor"/&gt; in DOM 
     var spreadsheet = new SocialCalc.SpreadsheetControl(); 
     spreadsheet.InitializeSpreadsheetControl(
         "tableeditor", 0, 0, 0
     ); 
     spreadsheet.ExecuteCommand(
         'set sheet defaulttextvalueformat text-wiki'
     ); </pre>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">将上述部份搭配起来后，<strong style="text-align:left;font-weight:bold;">绘制</strong>步骤的工作流程将类似这样：</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="richtext-flow.png" style="width:760px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">大功告成！改进后的 SocialCalc 能够支持丰富的Wiki标记语法：</div>
<pre style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;color:rgb(51, 51, 51);display:block;background-color: rgb(245, 245, 245); border-top-left-radius:4px 4px;border-top-right-radius:4px 4px;border-bottom-right-radius:4px 4px;border-bottom-left-radius:4px 4px;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;font-size:16px;line-height:150%;border-width: 1px; border-style: solid; margin: 0px 0px 9px; padding: 8.5px; border-color: rgba(0, 0, 0, 0.148438); ">    *bold* _italic_ `monospace` {{unformatted}}
    &gt; indented text
    * unordered list
    # ordered list
    "Hyperlink with label"&lt;http://softwaregarden.com/&gt;
    {image: http://www.socialtext.com/images/logo.png}</pre>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">请尝试在&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">A1</code>&nbsp;中输入&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">*bold* _italic_ `monospace`</code>，随后即可看到绘制后的富文本内容：</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="richtext-example.png" style="width:287px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
</section>
<section style="text-align:left;display:block;padding-left:10%;padding-right:10%;">
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h2 id="ch5" style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;font-size:24px;line-height:36px;margin: 0px; ">即时多人协作</h2>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">我们接下来研究的一个例子，是在共享的电子表格里进行多人即时协同编辑。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">这乍看之下也许有点复杂，但是感谢 SocialCalc 的模组化设计，我们只需让每位使用者将自己的指令传播给其他参与者执行即可。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">为了对本地指令与远端指令作出区分，我们为&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">ScheduleSheetCommands</code>&nbsp;方法增加了&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">isRemote</code>&nbsp;参数：</div>
<pre style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;color:rgb(51, 51, 51);display:block;background-color: rgb(245, 245, 245); border-top-left-radius:4px 4px;border-top-right-radius:4px 4px;border-bottom-right-radius:4px 4px;border-bottom-left-radius:4px 4px;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;font-size:16px;line-height:150%;border-width: 1px; border-style: solid; margin: 0px 0px 9px; padding: 8.5px; border-color: rgba(0, 0, 0, 0.148438); ">    SocialCalc.ScheduleSheetCommands =
        function(sheet, cmdstr, saveundo, isRemote) {
            if (SocialCalc.Callbacks.broadcast &amp;&amp; !isRemote) {
                SocialCalc.Callbacks.broadcast('execute', {
                    cmdstr: cmdstr,
                    saveundo: saveundo
                });
            }
            // ...original ScheduleSheetCommands code here...
        };</pre>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">现在只需定义一个合适的&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">SocialCalc.Callbacks.broadcast</code>&nbsp;回调函数，即可让所有连入此电子表格的客户端执行相同的指令。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">当 SEETA&nbsp;<a href="http://seeta.in/wiki/index.php?title=Collaboration_in_SocialCalc" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">Sugar Labs</a>&nbsp;于 2009 年在 OLPC 上首次实作这项功能时，<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">broadcast</code>&nbsp;函数是用 XPCOM 框架写成，并在 OLPC/Sugar 的标准传输层 D-Bus/Telepathy 网络上运行：</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="collab-olpc.png" style="width:554px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">这样的运行方式，让 Sugar 网络里的 XO 电脑能对共同的 SocialCalc 电子表格进行协作，但也只能在 Mozilla/XPCOM 浏览器平台与 D-Bus/Telepathy 讯息平台上适用。</div>
<h3 style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;line-height:27px;font-size:20px;margin: 0px; ">跨浏览器传输</h3>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">为了达成跨浏览器、跨作业系统的目标，我们使用&nbsp;<a href="http://search.cpan.org/dist/Web-Hippie/" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">Web::Hippie</a>&nbsp;框架，作为 JSON 在 WebSocket 上传输的抽象层。它提供方便的 jQuery 绑定，并且当 WebSocket 不适用时，也能利用 MXHR (<a href="http://about.digg.com/blog/duistream-and-mxhr" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">multipart XMLHttpRequest</a>) 作为备用传输机制.</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">对于安装了 Adobe Flash 插件但没有原生 WebSocket 支持的浏览器，我们使用&nbsp;<a href="https://github.com/gimite/web-socket-js" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">web_socket.js</a>&nbsp;项目的 Flash WebSocket 模拟器，这通常比 MXHR 更快也更可靠。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">运作流程看上去是这样的:</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="collab-flow.png" style="width:702px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">客户端的&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">SocialCalc.Callbacks.broadcast</code>&nbsp;函数定义如下:</div>
<pre style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;color:rgb(51, 51, 51);display:block;background-color: rgb(245, 245, 245); border-top-left-radius:4px 4px;border-top-right-radius:4px 4px;border-bottom-right-radius:4px 4px;border-bottom-left-radius:4px 4px;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;font-size:16px;line-height:150%;border-width: 1px; border-style: solid; margin: 0px 0px 9px; padding: 8.5px; border-color: rgba(0, 0, 0, 0.148438); ">    var hpipe = new Hippie.Pipe();

    SocialCalc.Callbacks.broadcast = function(type, data) {
        hpipe.send({ type: type, data: data });
    };

    $(hpipe).bind("message.execute", function (e, d) {
        var ss = SocialCalc.CurrentSpreadsheetControlObject;
        ss.context.sheetobj.ScheduleSheetCommands(
            d.data.cmdstr,
            d.data.saveundo,
            true // isRemote = true
        );
        break;
    });</pre>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">尽管这已经能顺利运行，我们仍然有两个问题需要解决。</div>
<h3 style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;line-height:27px;font-size:20px;margin: 0px; ">冲突解决</h3>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">第一个就是为了执行指令而产生的争用状态：如果使用者 A 与 B 同时执行某个影响相同存储格的操作，之后才接收到与对方传播出来的指令，那么双方将会停在不同的状态：</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="collab-conflict.png" style="width:684px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">我们可以通过 SocialCalc 内置的还原/重作机制来解决这个问题，如下图所示：</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="collab-resolution.png" style="width:685px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
<ul style="text-align:left;list-style: disc outside none; margin: 0px 0px 9px 25px; padding: 0px; ">
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">当客户传播出一个指令时，会将指令添加到<strong style="text-align:left;font-weight:bold;">待办</strong>队列。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">当客户接收到一个指令时，检查<strong style="text-align:left;font-weight:bold;">待办</strong>队列：
<ul style="text-align:left;list-style: disc outside none; margin: 0px 0px 0px 25px; padding: 0px; ">
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">如果<strong style="text-align:left;font-weight:bold;">待办</strong>队列为空，则直接执行这项远端指令。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">如果它符合<strong style="text-align:left;font-weight:bold;">待办</strong>队列里的本地指令，则将它将从队列中移除。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">否则，检查队列中是否有指令与接收到的指令相冲突：
<ul style="text-align:left;list-style: disc outside none; margin: 0px 0px 0px 25px; padding: 0px; ">
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">如果存在冲突指令，则先<strong style="text-align:left;font-weight:bold;">还原</strong>这些指令，并将其标记为稍后<strong style="text-align:left;font-weight:bold;">重作</strong>。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">在还原所有的冲突指令之后，将远端指令按正常状态执行。</li>
</ul>
</li>
</ul>
</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">当从服务器上接收到标记为<strong style="text-align:left;font-weight:bold;">重做</strong>的指令时，客户端将再次执行指令，再从队列中将其移除。</li>
</ul>
<h3 style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;line-height:27px;font-size:20px;margin: 0px; ">远端游标</h3>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">尽管争用状态已经得到解决，但“偶尔会覆盖掉其他使用者正在编辑的存储格”这样的不理想情形还是存在。我们可以更进一步，将每位使用者的游标位置传播给其他使用者，让每个人都能看到有哪些存储格正在编辑。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">为了实做这一想法，我们为&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">MoveECellCallback</code>&nbsp;事件添加了另一个&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">broadcast</code>&nbsp;处理程序:</div>
<pre style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;color:rgb(51, 51, 51);display:block;background-color: rgb(245, 245, 245); border-top-left-radius:4px 4px;border-top-right-radius:4px 4px;border-bottom-right-radius:4px 4px;border-bottom-left-radius:4px 4px;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;font-size:16px;line-height:150%;border-width: 1px; border-style: solid; margin: 0px 0px 9px; padding: 8.5px; border-color: rgba(0, 0, 0, 0.148438); ">    editor.MoveECellCallback.broadcast = function(e) {
        hpipe.send({
            type: 'ecell',
            data: e.ecell.coord
        });
    };

    $(hpipe).bind("message.ecell", function (e, d) {
        var cr = SocialCalc.coordToCr(d.data);
        var cell = SocialCalc.GetEditorCellElement(
            editor, cr.row, cr.col
        );
        // ...decorate cell with styles specific
        //    to the remote user(s) on it...
    });</pre>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">在电子表格中标记存储格焦点时，通常会使用带有颜色的边框。但是，该存储格也许已经有自己的&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">border</code>&nbsp;属性了。而由于&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">border</code>&nbsp;为单一颜色，因此在相同的存储格只能表现一个游标。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">因此，在支持 CSS3 的浏览器上，我们使用&nbsp;<code style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;border-top-left-radius:3px 3px;border-top-right-radius:3px 3px;border-bottom-right-radius:3px 3px;border-bottom-left-radius:3px 3px;color:rgb(221, 17, 68);background-color: rgb(247, 247, 249); font-size:16px;line-height:150%;border-width: 1px; border-style: solid; padding: 2px 4px; border-color: rgb(225, 225, 232); ">box-shadow</code>&nbsp;功能来表现多个游标:</div>
<pre style="text-align:left;font-family:Menlo, Monaco, 'Courier New', monospace;color:rgb(51, 51, 51);display:block;background-color: rgb(245, 245, 245); border-top-left-radius:4px 4px;border-top-right-radius:4px 4px;border-bottom-right-radius:4px 4px;border-bottom-left-radius:4px 4px;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;font-size:16px;line-height:150%;border-width: 1px; border-style: solid; margin: 0px 0px 9px; padding: 8.5px; border-color: rgba(0, 0, 0, 0.148438); ">    /* Two cursors on the same cell */
    box-shadow: inset 0 0 0 4px red, inset 0 0 0 2px green;</pre>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">如此一来，当四人编辑同一个电子表格时，屏幕看起来会像这样:</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; "><img src="collab-borders.png" style="width:209px;text-align:left;height:auto;vertical-align:middle;margin-left:10%;border-width: 0px; border-style: none; border-color: white; "></div>
</section>
<section style="text-align:left;display:block;padding-left:10%;padding-right:10%;">
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h2 id="ch6" style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;font-size:24px;line-height:36px;margin: 0px; ">开发经验谈</h2>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">笔者在 2009 年 6 月时加入 SocialCalc 项目团队。经过四个月的密集作业，我们在 10 月 19 日（VisiCalc 的 30 周年纪念日）发表了 SocialCalc 1.0 版。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">从
 WikiCalc 到 SocialCalc，中间经历了三年的开发。相形之下，最后这四个月只是一段短暂的时间。尽管如此，这段和 
Socialtext 同事在 Dan Bricklin 的指导下进行协作的过程，仍使我获益匪浅。在此，笔者想将那段时间学到的经验分享给大家。</div>
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h3 style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;line-height:27px;font-size:20px;margin: 0px; ">愿景清晰的首席设计师非常重要</h3>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">在《设计的设计（The Design of Design）》一书中，Fred Brooks 认为，在建构复杂系统时，若能专注于清晰连贯的设计概念，而非各自为政的想法，那么沟通成本将会大幅下降。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">依 Brooks 的想法，这种连贯式设计概念的构想，最好能由一个人来主导：</div>
<blockquote style="text-align:left;border-left-color:rgb(238, 238, 238);border-width: medium medium medium 5px; border-style: none none none solid; margin: 0px 0px 18px; padding: 0px 0px 0px 15px; "><span style=""></span><div style="text-align:left;font-weight:300;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px; ">概念的完整性是伟大设计中最重要的特性。由于完整的概念只能出自一人或少数人的合作构想，因此明智的管理者会大胆委托才华出众的首席设计师，来承担整个设计任务。</div><span style=""></span></blockquote>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">对
于 SocialCalc 这个项目来说，让 Tracy Ruggles 担任首席用户体验设计师，是让我们成功实现原初构想的关键。由于 
SocialCalc 的底层引擎十分易于扩展，因此各种新功能的想法往往层出不穷；Tracy 
透过草图进行原型设计的才能，为我们提供了巨大的帮助，让我们能用最直观的方式呈现出所有的功能。</div>
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h3 style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;line-height:27px;font-size:20px;margin: 0px; ">Wiki确保项目延续</h3>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">在我加入项目之前，SocialCalc 已有超过两年的设计和开发历史，但我却能在几天之内立刻赶上进度，开始作出贡献。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">这是因为“所有信息都在Wiki里”– 从早期的设计草稿到最新的浏览器支持清单，整个流程都详细记载在Wiki页面和 SocialCalc 电子表格里。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">通过阅读该项目的相关记录，让我能跳过新成员加入时常见的上手期，快速跟上目前的进度。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">这在传统的开源项目比较少见。传统项目中大部分的交流都是在 IRC 和邮件论坛中进行的，而Wiki（如果有使用的话）往往只用来存放相关资源的记录和链结 – 如果有新人加入，要想通过结构混乱的 IRC 纪录和邮件存档追赶进度，无疑会更加困难。</div>
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h3 style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;line-height:27px;font-size:20px;margin: 0px; ">善加运用时区差异</h3>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">Ruby on Rails 的发明人 David Heinemeier Hansson 在加入 37signals 时，曾这样评价分布式团队的优势：</div>
<blockquote style="text-align:left;border-left-color:rgb(238, 238, 238);border-width: medium medium medium 5px; border-style: none none none solid; margin: 0px 0px 18px; padding: 0px 0px 0px 15px; "><span style=""></span><div style="text-align:left;font-weight:300;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px; ">哥本哈根和芝加哥之间相隔的七个时区，实际上减少了我们受到的打扰，让我们做出更多工作。</div><span style=""></span></blockquote>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">在 SocialCalc 的研发过程中，对于台北和帕罗奥图之间相隔的九个时区，我们亦有同感。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">通常我们会在一天 24 小时内，完成一次“设计-开发-品管”反馈循环，每个环节用到某个人的八小时。这种非同步式的协作，促使我们运用能自我描述的完整作品（设计草图、代码，以及测试）来沟通，从而大幅增进相互之间的信任。</div>
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h3 id="ofun" style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;line-height:27px;font-size:20px;margin: 0px; ">乐趣最优</h3>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">笔者在 2006 年于 CONISLI 会议上所作的主题演讲“<a href="http://www.slideshare.net/autang/ofun-optimizing-for-fun" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">-OFun：乐趣最优（Optimizing for Fun）</a>”里，将自己领导分布式团队开发 Perl 6 语言的经验，总结为几个重点。其中“随时保持蓝图清晰”、“事后宽恕 &gt; 事前许可”、“打破僵局”、“不求共识，只求创意”，以及“使用代码描述概念”这几项，特别适合小型的分布式团队。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">因此，在开发 SocialCalc 时，我们特别重视团队成员间的知识分享，以确保每个人都不会成为主要瓶颈。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">另外，当设计过程出现多种备选方案时，我们会主动将每个方案都进行实做，以深入探勘它们的设计空间，并先一步解决可能出现的冲突。如果在此过程里发现有更好的设计，我们也不怕将整个原型打掉重写。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">虽然缺乏面对面交流，但这些文化特质帮我们培养相互之间的信任和情谊，并将争议降到最低，让 SocialCalc 的开发成为一件乐事。</div>
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h3 style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;line-height:27px;font-size:20px;margin: 0px; ">通过故事测试推动开发工作</h3>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">在加入 Socialtext 前，我曾倡导“将测试写进规格里”的方法，这一点在&nbsp;<a href="http://perlcabal.org/syn/S02.html" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">Perl 6 语言规格</a>&nbsp;中就能看到：我们逐段帮规格加上测试，并持续确保两者之间的同步。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">然而 SocialCalc 项目品管团队的成员 Ken Pier 和 Matt Heusser 却让我大开眼界 – 原来这种做法还可以更进一步，将测试提升到“可以执行的规格”这个境界。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">在《美妙的测试（Beautiful Testing）》一书第 16 章，“剥开 Socialtext 的玻璃洋葱”里，Matt 用如下方式解释了我们由“故事测试”推动的开发流程：</div>
<blockquote style="text-align:left;border-left-color:rgb(238, 238, 238);border-width: medium medium medium 5px; border-style: none none none solid; margin: 0px 0px 18px; padding: 0px 0px 0px 15px; "><span style=""></span><div style="text-align:left;font-weight:300;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px; ">工作的最基本单元是一系列“故事”，也就是一系列非常轻量级的需求文件。</div>
<div style="text-align:left;font-weight:300;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px; ">每个故事只包含对一个功能的简要描述，以及此功能的运作实例，用最直白的文句进行描述。我们称这些实例为“接纳度测试”。</div>
<div style="text-align:left;font-weight:300;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px; ">在故事形成初期，设计师会先写出初步的接纳度测试，随后由开发人员和测试人员进行讨论，之后开发人员才开始编写代码。</div><span style=""></span></blockquote>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">随后这些故事测试会被转换为“Wiki测试（wikitests）”。这是一种基于表格的语言，脱胎自 Ward Cunningham 的&nbsp;<a href="http://fit.c2.com/" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">FIT 框架</a>。用此语言写成的测试存进Wiki系统后，会自动连接到&nbsp;<a href="http://search.cpan.org/dist/Test-WWW-Mechanize/" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">Test​::WWW​::Mechanize</a>&nbsp;和&nbsp;<a href="http://search.cpan.org/dist/Test-WWW-Selenium/" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">Test​::WWW​::Selenium</a>&nbsp;等测试框架，成为自动测试流程的一环。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">用故事测试作为“表达需求”和“验证需求”的共通语言，这种做法的好处一言难尽。它不但大幅节省了沟通成本，也让我们能每个月对系统进行一次改版时，不用担心已经修复的瑕疵会再次出现。</div>
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h3 style="text-align:left;font-family:inherit;font-weight:bold;color:inherit;text-rendering:optimizelegibility;line-height:27px;font-size:20px;margin: 0px; " id="cpal" name="cpal">CPAL 开源授权</h3>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">最后，我们针对 SocialCalc 而设计的开源授权，也令我们受益匪浅。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">Socialtext 为了 SocialCalc，设计出通用公共授权（<a href="https://www.socialtext.net/open/cpal" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">Common Public Attribution License</a>）。CPAL 以 Mozilla 公共授权为基础，并让原作者可以要求在软件的界面上显示自己的标志。CPAL 还加上了“网络使用条款”，让衍生作品在透过网络提供服务时，也授予一般使用者取得源代码的权利。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">在获得<a href="http://opensource.org/" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">开放源代码促进会</a>和<a href="http://www.fsf.org/" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">自由软件基金会</a>的认可后，已经有不少知名网站（例如&nbsp;<a href="https://github.com/facebook/platform" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">Facebook</a>&nbsp;和&nbsp;<a href="https://github.com/reddit/reddit" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">Reddit</a>）选择用 CPAL 方式发布自己的平台源代码，这对我们无疑是莫大的鼓励。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">因为 CPAL 属于“较弱型著佐权（weak copyleft）”授权，因此开发人员可以将它整合进任何自由软件或私有软件里，只需要分享出针对 SocialCalc 本身的修改。这让各个社区都可以采用 SocialCalc ，并对其进行改进。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">底下是一些以&nbsp;<a href="https://github.com/DanBricklin/socialcalc" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">SocialCalc</a>&nbsp;为基础的开源项目：</div>
<ul style="text-align:left;list-style: disc outside none; margin: 0px 0px 9px 25px; padding: 0px; ">
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">Drupal 的&nbsp;<a href="http://drupal.org/project/sheetnode" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">Sheetnode 项目</a>，及其自行维护的&nbsp;<a href="https://github.com/infojunkie/socialcalc" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">SocialCalc 分支</a>。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">Luke Closs 发起的&nbsp;<a href="https://github.com/lukec/socialcalc-xocom" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">OLPC/XOCOM 平台移植版</a>。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">SEETA 的&nbsp;<a href="http://seeta.in/wiki/index.php?title=SocialCalc_on_Sugar" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">OLPC/Sugar 平台移植版</a>，由 Luke 的版本衍生而来。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">SEETA 的&nbsp;<a href="http://www.seeta.in/wiki/index.php?title=SocialCalc_on_PalmPre" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">Palm Pre 平台移植版</a>。</li>
<li style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;">Ramu Ramamurthy 的&nbsp;<a href="https://github.com/shrek/socialcalc/tree/master/JvmServer" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">Scala/Java 电子表格服务器项目</a>。</li>
</ul>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">本章中的范例，包括富文本和协作编辑等功能，都能在&nbsp;<a href="http://github.com/audreyt/ethercalc" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">http://github.com/audreyt/ethercalc</a>&nbsp;下载。WikiCalc 1.0 代码的历史存档，则可由&nbsp;<a href="http://github.com/audreyt/wikicalc" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">http://github.com/audreyt/wikicalc</a>&nbsp;取得。</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">开源的网页电子表格引擎，有许多有趣的应用可能。如果您能将 SocialCalc 嵌入到您自己的项目中，这绝对是我们喜闻乐见的。</div>
<div style="text-align:left;font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;font-size:20px;line-height:150%;padding-bottom:10px;margin: 0px 0px 9px; ">Happy Hacking!</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct1;visibility:visible;margin: 0px 0px 9px; ">唐凤</div>
</section>
</section>
<hr>
<section class="book" style="text-align:left;display:block;">
<div style="text-align:left;padding-bottom:17px;border-bottom-color:rgb(238, 238, 238);font-family:ct1;visibility:visible;border-width: medium medium 1px; border-style: none none solid; margin: 18px 0px; ">
<h1 id="book2" style="text-align:left;font-family:inherit;color:inherit;text-rendering:optimizelegibility;font-size:30px;line-height:1;font-weight:normal;margin: 0px; ">性能架构</h1>
</div>
<div style="text-align:left;font-size:20px;line-height:150%;padding-bottom:10px;font-family:ct2;visibility:visible;margin: 0px 0px 9px; ">
以下是<a target="_blank" href="http://aosabook.org/" style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">《开源应用程序性能》</a>EtherCalc 章节的中文译本，全文采用
<a style="text-align:left;color:rgb(0, 136, 204);text-decoration:none;white-space:nowrap;">CC0 条款</a>，属于公众领域。
</div>
<h2 id="cha">从 SocialCalc 到 EtherCalc</h2>
<p>先前在<a target="_blank" href="http://ethercalc.tw/">《开源应用程序架构》</a> 一书中，我介绍了 SocialCalc 这个在浏览器中运行的电子表格编辑器，以取代服务器为中心的 WikiCalc 架构。SocialCalc 在浏览器中执行所有的计算，只有在载入和存储电子表格时才会使用服务器。</p>
<p>追求性能是 Socialtext 团队在 2006 年时设计 SocialCalc 的主要目的。重点在于：在 JavaScript 
环境下执行客户端计算，尽管在当年的速度仅有服务器端 Perl 计算的十分之一，但仍然胜过 AJAX 来回传输资料造成的网络延迟：</p>
<hr><p>
<img src="wikicalc-socialcalc-zh-tw.png" alt="WikiCalc 與 SocialCalc 架構比較" title="自 2009 年起，JavaScript 的执行速度已将图中的 50ms 减为 &lt;10ms。" style="max-width:100%;" width="100%"></p>
<hr><p>《开源应用程序架构》的最后一段里，我们介绍了如何透过一种简单、类似聊天室的架构，来进行电子表格同步协作：</p>
<hr><p>
<img src="multiplayer-socialcalc-zh-tw.png" alt="多人連線版 SocialCalc" style="max-width:100%;" width="100%"></p>
<hr><p>然而，当我们开始进行上线测试时，却发现它的性能与扩展性不符实际需求，这也激发我们重写整个系统，以便达到可接受的性能水准。</p>
<p>本章将会讨论 <a target="_blank" href="http://ethercalc.tw/">EtherCalc</a> 系统的演进过程。它是 SocialCalc 的后续项目，为电子表格提供多人同步的编辑功能。我们会详述系统架构的沿革，介绍相关的性能分析工具，以及我们创造出哪些新的工具来克服性能上的问题。</p>
<h2 id="chb">设计限制</h2>
<p>Socialtext 平台同时具有“防火墙内”及“云端部署”两种选项，这对 EtherCalc 
的资源及性能需求增加了独特的限制。本书写作时，Socialtext 在 vSphere 为基础的内部网络主机服务内的最低需求，是双核心处理器和 
4GB 的内存容量。典型的 EC2 虚拟主机服务则提供大约两倍的性能，相当于四核心和 7.5GB 的内存容量。</p>
<p>内部网络的部署需求，代表我们不能像多租户的主机模式系统那样，靠扩充硬件来解决问题（例如 DocVerse，后来成为 Google Docs 的一部分）；系统必须能在一个普通的服务器上运行。</p>
<p>相较于内部网络部署，云端主机可以藉由随选扩充，来提供较高的性能，但是浏览器的网络连线通常比较慢，而且断线与重新连线的状况相当频繁。</p>
<p>综上所述，这些形塑 EtherCalc 架构方向的资源所受的限制有：</p>
<ul>
<li><p><strong>内存</strong>：以事件为基础的服务器，能让我们用较少的内存处理数千个同时发生的网络连线。</p></li>
<li><p><strong>处理器</strong>：基于 SocialCalc 的原始设计，我们把大部分计算及所有内容绘制移到客户端 JavaScript 运行，以减少服务器的负载。</p></li>
<li><p><strong>网络</strong>：传送电子表格操作指令而非内容，可降低所需的带宽，并从不稳定的网络连线上恢复。</p></li>
</ul>
<h2 id="chc">初步原型</h2>
<p>我们首先用 Perl 5 语言撰写了一套 WebSocket 服务器，透过 Socialtext 开发的 <a target="_blank" href="https://metacpan.org/release/Feersum">Feersum</a> 这个以 libev 为基础的事件引擎提供支持。Feersum 的速度相当快，在一般状况下每秒可处理上万笔请求。</p>
<p>除了 Feersum 以外，我们还使用中间件 <a target="_blank" href="https://metacpan.org/release/PocketIO">PocketIO</a>，接上广受好评的 Socket.io JavaScript 客户端，以相容于尚未支持 WebSocket 的旧版浏览器。</p>
<p>这个初步原型跟聊天室服务器十分相似，每个协作时段就相当于一个聊天室；客户端可以将本地的执行指令及游标动作传送到服务器，然后透过服务器转送给同一个聊天室里的所有客户。</p>
<p>典型的操作流程就像这样：</p>
<hr><p>
<img src="flow-prototype-zh-tw.png" alt="紀錄重播式的原型伺服器" style="max-width:100%;" width="100%"></p>
<hr><p>服务器在纪录每个收到的指令时，都会附上时间戳。如果客户断线后又重新连线，它可以撷取这段时间的积存纪录，然后重新执行那些指令，以达到跟其他人相同的状态。</p>
<p>如同我们在《开源应用程序架构》提到的，这个简单的设计大幅减少了服务器端的处理器与内存需求，并且可以在网络连线失败的状况下，展现出合理的复原能力。</p>
<h2 id="chd">第一个瓶颈</h2>
<p>然而，我们在 2011 年 6 月实地测试雏型时，却发现随着协作编辑的执行时段愈长，就会出现愈严重的性能问题。</p>
<p>由于电子表格是长久存在的文件，因此经过数周的编辑，协作时段可能会累积数千笔的修改纪录。</p>
<p>在前述的积存纪录模型下，在新客户端加入协作时段时，势必遇上明显的启动延迟：它得先重新执行数千个指令，才能进行任何修改。</p>
<p>为了减轻这个问题，我们采用了快照机制。每当 100 
个指令传送到协作时段后，服务器就会调查在线每个客户的状态，然后将最新收到的快照存储在积存纪录中。新加入的客户端仅需接收这个快照，以及快照存储之后
新输入的指令即可。这样一来，它最多只需要重新执行 99 个指令。</p>
<hr><p>
<img src="flow-snapshot-zh-tw.png" alt="加入快照機制的原型伺服器" style="max-width:100%;" width="100%"></p>
<hr><p>这个权宜之计解决了新加入客户端的处理器延迟问题，但却带来了网络性能不佳的问题，因为它会每隔一阵子，就耗用每个客户端的上载带宽。若是连线速度缓慢，客户端后续指令的发送时间就会受到延迟。</p>
<p>除此以外，服务器没有办法确认客户端上传的快照是否正确。错误的快照会弄乱所有新加入者的状态，导致它们和其他其他共同编辑者失去一致性。</p>
<p>细心的读者也许会发现，这两个问题的症结，都是因为服务器缺乏执行电子表格指令的能力。如果服务器在接收到每个指令时，可以自行更新内部的电子表格状态，它其实根本不需要维护指令的积存纪录。</p>
<p>浏览器内的 SocialCalc 电子表格引擎，是用 JavaScript 语言写成。我们曾考虑过把它的逻辑转译成 Perl，以在服务器端执行，但是维护两套程序码需要付出极大的成本。我们也尝试在服务器端嵌入 JavaScript 引擎（<a target="_blank" href="https://metacpan.org/release/JavaScript-V8">V8</a>、<a target="_blank" href="https://metacpan.org/release/JavaScript-SpiderMonkey">SpiderMonkey</a> 等），但它们在 Feersum 事件回圈里运作时，会产生许多性能上的问题。</p>
<p>到了 2011 年 8 月，我们终于决定打掉重练，用 Node.js 重写服务器。</p>
<h2 id="che">移植到 Node.js</h2>
<p>由于 Feersum 和 Node.js 都以 libev 事件模型为基础，而且 Pocket.io 的程序接口跟 Socket.io 几乎相同，所以最初的改写十分顺利。</p>
<p>感谢 <a target="_blank" href="http://zappajs.com/">ZappaJS</a> 框架提供的简洁接口，我们只花了一个下午，用了 80 行程序，就写出了功能相当的服务器。</p>
<p>简单的<a target="_blank" href="http://achilles.hukaa.com/?p=8">性能测试</a>显示，Node.js 的处理效率比 Feersum 少了一半左右：在 2011 年的 Core i5 处理器上，Feersum+Tatsumaki 每秒可处理 5000 次请求，而 Node.js+Express 的每秒上限约为 2800 次请求。</p>
<p>由于这还在我们可接受的范围内，不致于影响日常使用，因此我们接受这项缺陷，并且期望它在一段时间后会有所改善。</p>
<p>在初步移植完毕之后，我们便着手将每个编辑阶段的电子表格状态存放在服务器端，以减少客户端的处理器使用，并大幅降低所需的带宽：</p>
<hr><p>
<img src="flow-nodejs-zh-tw.png" alt="將試算表狀態存放於 Node.js 伺服器上" style="max-width:100%;" width="100%"></p>
<hr>
<h2 id="chf">服务器端 SocialCalc</h2>
<p><a target="_blank" href="https://github.com/tmpvar/jsdom">jsdom</a> 是提升作业性能的关键技术，它完整实作了 W3C 文件对象模型，让 Node.js 能在模拟的浏览器环境内，载入写给客户端的 JavaScript 程序库。</p>
<p>利用 jsdom，我们可以在服务器端任意创建 SocialCalc 电子表格，它们会在各自的沙盒里进行计算：</p>
<pre><code>require! &lt;[ vm jsdom ]&gt;
create-spreadsheet = -&gt;
  document = jsdom.jsdom \&lt;html&gt;&lt;body/&gt;&lt;/html&gt;
  sandbox  = vm.createContext window: document.createWindow! &lt;&lt;&lt; {
    setTimeout, clearTimeout, alert: console.log
  }
  vm.runInContext """
    #packed-SocialCalc-js-code
    window.ss = new SocialCalc.SpreadsheetControl
  """ sandbox
</code></pre>
<p>每个协作时段都对应到一个沙盒内的 SocialCalc 控制器，即时执行客户端传来的指令。当新客户端加入时，服务器仅需传送电子表格控制器内的最新状态，从而彻底解决积存纪录带来的性能问题。</p>
<p>对测试结果感到满意之后，我们编写了一个以 Redis 为基础的存储引擎，并在 <a target="_blank" href="http://ethercalc.org/">EtherCalc.org</a> 公开测试。在接下来的六个月里，它展现了极佳的扩展性，顺利执行了数百万笔电子表格运作，没有发生任何状况。</p>
<p>2012 年 4 月，我在 OSDC.tw 大会上以 EtherCalc 为主题发表演讲，之后趋势科技公司邀我参加他们的黑客松，将 EtherCalc 改作成可编程序的视觉化引擎，用来即时监视网络流量资料。</p>
<p>为了这个使用案例，我们制作 REST 接口，以便用 GET、PUT 存取电子表格中的个别存储格，并使用 POST 
将指令直接发送到电子表格内。在这场黑客松里，崭新的 REST 
处理器每秒接收数百笔呼叫，在浏览器中即时更新图像及公式格内容，完全没有发生速度减缓或内存泄漏的状况。</p>
<p>然而在最后展示会上，当我们将流量资料输送到 EtherCalc，开始把公式输入浏览器中的电子表格时，服务器突然当掉，冻结了所有执行中的连线。我们重新执行 Node.js 作业，却只见它耗用 100% 的处理器资源，随即又锁住不动。</p>
<p>吃惊之余，我们换回较早的资料重新执行。它的运作没有问题，也让我们的展示得以完成。但我不禁在想：一开始导致程序当掉的原因究竟是什么？</p>
<h2 id="chg">Node.js 性能分析</h2>
<p>要找出 CPU 卡在哪里，就得使用性能分析器。</p>
<p>Perl 初步原型的性能监测方式相当简单明瞭，这大半要归功于优秀的 <a target="_blank" href="https://metacpan.org/module/Devel::NYTProf">NYTProf</a> 工具，它能利用详尽的 HTML 报告以及互动式的<a target="_blank" href="https://metacpan.org/module/nytprofcg">函数呼叫视觉界面</a>，详细列出每个函数、每个区块、每列、每个操作码的时间信息。除此以外，我们也利用 Perl 内建的 <a target="_blank" href="https://metacpan.org/module/perldtrace">DTrace 支持</a>，针对长时运行的程序，取得函数出入的即时数据。</p>
<p>相形之下，Node.js 的性能分析工具还有很大的进步空间。截至此时，DTrace 仍只能在 <a target="_blank" href="http://blog.nodejs.org/2012/04/25/profiling-node-js/">illumos 系作业系统</a>的 32 位元模式下运行，因此我们大多得靠 <a target="_blank" href="https://github.com/c4milo/node-webkit-agent">Node Webkit Agent</a> 提供的分析接口，即使它只提供函数层级的数据资料。</p>
<p>典型的运行方式如下：</p>
<pre><code># "lsc" 是 LiveScript 编译器
# 先载入 WebKit agent 模组，然后执行 app.js:
lsc -r webkit-devtools-agent -er ./app.js
# 另开一个终端机页签，启动分析器：
killall -USR2 node
# 在 WebKit 浏览器里开启下列网址，开始性能分析：
open http://tinyurl.com/node0-8-agent
</code></pre>
<p>为了重现沉重的后台负载，我们运用 <a target="_blank" href="http://httpd.apache.org/docs/trunk/programs/ab.html">ab</a> 执行高度并行的 REST API 呼叫程序。为了模拟移动游标、更新公式等浏览器端的运作状况，我们采用了同样以 jsdom 和 Node.js 编写的无显示接口浏览器 <a target="_blank" href="http://zombie.labnotes.org/">Zombie.js</a>。</p>
<p>有趣的是，我们发现瓶颈正是出在 jsdom 本身：</p>
<p>
<img src="profiler-jsdom.png" title="ab -n 10000 /_/1/html # 540rps" style="max-width:100%;" width="100%"></p>
<p>从上面的报告中可以看出，<code>RenderSheet</code> 占用 CPU 的时间最多：每当收到指令时，服务器都会用几微秒的时间重新绘制单元格的 <code>innerHTML</code> 属性，以反映指令的执行效果。</p>
<p>因为所有 jsdom 代码都在同一个线程中运行，所以后续的 REST API 呼叫将会卡住，直到上一命令的绘制过程结束为止。在高度并行的情况下，过长的队列触发了潜藏的瑕疵，最终使服务器当掉。</p>
<p>我们在仔细检查了对象使用情况之后，发现绘制结果几乎毫无用处，因为服务器端根本毋需即时显示 HTML 内容。唯一用到绘制结果的是“汇出 HTML”这个 API，但其实我们可以等到实际有人呼叫它时，再利用内存内的电子表格结构，绘制出每个单元格的 <code>innerHTML</code> 属性。</p>
<p>所以，我们移除了 <code>RenderSheet</code> 函数，用 <a target="_blank" href="https://github.com/audreyt/ethercalc/commit/fc62c0eb#diff-c25a522afcbe1cc8c25cdf066e008670R97">20 行 LiveScript 代码</a> 重新实作了汇出 HTML 所需的极少数 DOM 接口，然后再运行了一次性能分析器：</p>
<p>
<img src="profiler-no-jsdom.png" alt="經過更新的效能分析器螢幕截圖（去除 jsdom）" title="ab -n 10000 /_/1/html # 2116rps" style="max-width:100%;" width="100%"></p>
<p>现在好多了！我们将流量提高了 4 倍，将 HTML 汇出速度加快了 20 倍，也顺利解决了死机问题。</p>
<h1>
</h1><h2 id="chh">多核心扩展</h2>
<p>这一轮改进完成后，我们终于觉得没有顾虑，可以将 EtherCalc 整合到 Socialtext 平台里，为Wiki页面和电子表格提供同时编辑的功能。</p>
<p>为了确保实际上线时的响应效率，我们部署了一个反向代理 nginx 服务器，利用它的 <a target="_blank" href="http://wiki.nginx.org/HttpLimitReqModule#limit_req">limit_req</a> 指令对 API 呼叫的速率设置上限。对于“防火墙内”和“专属远端服务器”这两种情况，执行结果确实都令人满意。</p>
<p>但是，对于中小型企业客户，Socialtext 还有第三种部署方式：“多户共用远端服务器”。在一台大型服务器里，我们同时为超过 35000 家公司提供服务，每家公司平均约有 100 位用户。</p>
<p>在这种多户共用情形里，所有执行 REST API 
调用的客户的请求，都会计入每秒的最大请求次数，从而使每位客户的实际限制都严格得多，平均限制约为每秒请求 5 
次。上一节中已经指出，这种限制的成因，是由于 Node.js 仅能使用一个 CPU 来执行所有计算操作：</p>
<hr><p>
<img src="scaling-evented-zh-tw.png" alt="事件伺服器（單處理器）" style="max-width:100%;" width="100%"></p>
<hr><p>是否有办法利用大型服务器里那些闲置的 CPU 呢？</p>
<p>对于运行在多核心机器上的其他 Node.js 服务，我们采用了预先分支的 <a target="_blank" href="https://npmjs.org/package/cluster-server">cluster-server</a> 模组，同时运行与 CPU 数量相同的进程：</p>
<hr><p>
<img src="scaling-cluster-zh-tw.png" alt="事件叢集伺服器（多處理器）" style="max-width:100%;" width="100%"></p>
<hr><p>尽管 EtherCalc 确实能同时运行在多个服务器上（透过 Redis 作统筹），但在单一服务器的情形下，<a target="_blank" href="http://stackoverflow.com/a/5749667">Socket.io 集群</a> 与 <a target="_blank" href="https://github.com/LearnBoost/Socket.IO/wiki/Configuring-Socket.IO">RedisStore</a> 的相互作用会使程序逻辑变得非常复杂，难以侦错。</p>
<p>此外，如果集群里的每个进程都在忙着处理 CPU 计算，新来的连线仍然会被卡住。</p>
<p>因此，我们决定不采用固定数量的预先分支进程，而是设法为服务器内的每份电子表格各创建一个线程，从而让每颗 CPU 平均分摊所有的指令执行工作：</p>
<hr><p>
<img src="scaling-threads-zh-tw.png" alt="事件執行緒伺服器（多處理器）" style="max-width:100%;" width="100%"></p>
<hr><p>W3C 定义的 <a target="_blank" href="http://www.w3.org/TR/workers/">Web Worker</a> 界面，刚好符合这项需求。它原先是为了浏览器环境下，独立运行的后台线程而设计。如此一来，长时间运行的后台任务，便不会影响主线程的响应速度。</p>
<p>因此，我写出了 <a target="_blank" href="https://github.com/audreyt/node-webworker-threads">webworker-threads</a> 这套 Node.js 模组，提供相容于 W3C 标准的跨平台接口。</p>
<p>利用 webworker-threads，可以轻易创建新的 SocialCalc 线程（每份电子表格约需 30kb 内存），并与其进行通信：</p>
<pre><code>{ Worker } = require \webworker-threads
w = new Worker \packed-SocialCalc.js
w.onmessage = (event) -&gt; ...
w.postMessage command
</code></pre>
<p>这套解决方案堪称两全其美：在多核环境下，我们可按照实际需求，分配多颗 CPU 供 EtherCalc 使用。在单核环境下，创建线程也仅需耗用极少的资源，即可将计算移到后台执行。</p>
<h2 id="chi">开发经验谈</h2>
<p>不像 SocialCalc 项目有精准的规格定义及团队开发流程，EtherCalc 在 2011 年中到 2012 年底的这段时间里，仅是笔者个人的<a target="_blank" href="http://www.ptt.cc/bbs/Soft_Job/M.1334510537.A.532.html">实验计划</a>，用来评估 Node.js 是否足堪正式上线使用。</p>
<p>这样不受限制的自由度，让笔者得以尝试各式各样的语言、函数库、算法及架构。在这里，我希望能向各位分享这 18 个月来的一些开发经验。</p>
<h2>
<a name="-5" class="anchor" href="#-5"><span class="mini-icon mini-icon-link"></span></a>限制带来解放</h2>
<p>Fred Brooks 在《设计的设计》一书中提到“限制”的重要性：它让设计者可以缩小搜寻空间、帮助专注并加速设计流程。这也包括了自行加诸的限制：</p>
<blockquote>
<p>在一个设计任务上加诸人为的限制有个好处，就是设计者日后可以自行放宽这些限制。在理想情况下，这可以引人踏进设计空间中未曾探索过的角落，藉以激发创意。</p>
</blockquote>
<p>在 EtherCalc 多次更迭的开发过程里，自行加诸的限制，让项目得以维持核心概念的完整。</p>
<p>举例来说，乍看之下，为三种不同的运行架构（内部网络、互联网、及多用户托管）各自定制一套服务器，似乎是不错的主意。但是，这种“过早的优化”，却会严重干扰核心概念的一致性。</p>
<p>与此相反，我持续专注在如何让 EtherCalc 在处理器、内存及网络同时受限时仍能运作顺畅，毋需顾此失彼。事实上，由于对于内存的需求小于 100MB，就算是像 Raspberry Pi 这样的嵌入式平台，都能轻松地运行 EtherCalc。</p>
<p>这样自我要求的设计，让将 EtherCalc 得以部署在三项资源都受限，而非只限制一项的“平台即服务”环境（例如 DotCloud、Nodejitsu 及 Heroku）下。这让人们可以轻易地架设电子表格服务，进一步促使独立的整合开发者作出更多贡献。</p>
<h3>
<a name="-6" class="anchor" href="#-6"><span class="mini-icon mini-icon-link"></span></a>
劣即是夯</h3>
<p>在 2006 年于芝加哥举办的 YAPC::NA 大会上，笔者受邀对开源社区的未来发表预测，以下是我<a target="_blank" href="http://pugs.blogs.com/pugs/2006/06/my_yapcna_light.html">当时的发言</a>：</p>
<blockquote>
<p>虽然我无法证明，但我认为明年 JavaScript 2.0 将会达成自举、编译回 JavaScript 1，并且取代 Ruby，成为各个环境中的明日之星。</p>
<p>我认为 CPAN 与 JSAN 将会整并；JavaScript 会成为所有动态语言的普遍基础。Perl 将可以编译成 JavaScript，在浏览器、服务器及数据库中运行，并共用一套开发工具。</p>
<p>正因为“劣即是夯”的缘故，所以最差劲的语言，注定会成为最棒的。</p>
</blockquote>
<p>我当时的看法，随着能以机器码速度执行的新一代 JavaScript 计算引擎出现，在 2009 年成为现实。到了 2012 年时，JavaScript 已成为“编写一次，随处运行”的虚拟机器；其他各式主要语言，包括 <a target="_blank" href="http://perlito.org/">Perl</a>，也都能被编译成 JavaScript。</p>
<p>除了客户端的浏览器与服务器端的 Node.js 之外，我们也让 JavaScript 能在 <a target="_blank" href="http://postgre.st/">Postgres 数据库内运行</a>，并在这三种运行环境下共用<a target="_blank" href="https://npmjs.org/">模组</a>。</p>
<p>是什么促成了社区这样快速的成长？回到我开发 EtherCalc 的初期，参加刚具雏形的 NPM 社区的经验，我推估这是因为 
JavaScript 并不强加特定的世界观到程序上，而是将自身融入许多不同的用途里。因此，创新者得以专注于创造字汇与用法（例如 jQuery 与
 Node.js），从同一个自由的核心出发，淬炼出自己心目中的“优良部份”。</p>
<p>对新加入的开发者来说，只学到语言的一小部份就可以上手开发；资深的开发者则可以挑战既有传统，将它修改演进成为更好的版本。相对于仰赖一群核心团
队将语言设计成适合所有预期的用途，JavaScript 的草根开发演进历程呼应了 Richard P. Gabriel 著名的<a target="_blank" href="http://www.dreamsongs.com/WorseIsBetter.html">“劣即是夯”</a>概念。</p>
<h3>
<a name="-7" class="anchor" href="#-7"><span class="mini-icon mini-icon-link"></span></a>旧语新枝</h3>
<p>相对于 <a target="_blank" href="https://metacpan.org/module/Coro::AnyEvent">Coro::AnyEvent</a> 直接了当的 Perl 语法，Node.js 以回调为基础的程序接口，迫使我们写出层层相叠、难以重复利用的内嵌函数。</p>
<p>在尝试过许多辅助流程控制的程序库之后，我们最后决定改用 <a target="_blank" href="http://livescript.net/">LiveScript</a> 这套崭新的程序语言。它的语法深受 Perl 及 Haskell 影响，并且可以直接转译成 JavaScript。</p>
<p>事实上，EtherCalc 历经四种一脉相承的语言：JavaScript、CoffeeScript、Coco 与 LiveScript，每次移植都带来更好的表达力。<a target="_blank" href="http://js2coffee.org/">js2coffee</a> 与 <a target="_blank" href="http://js2ls.org/public/">js2ls</a> 这些自动转译工具，也让程序码得以保有向前及向后的兼容性。</p>
<p>由于 LiveScript 直接编译成为 JavaScript，用它写出来的程序可以用原生速度运作，同时也完整支持以函数为范围的性能分析器。</p>
<p>LiveScript 使用新颖的建构方式，像是 <a target="_blank" href="http://livescript.net/#backcalls">backcall</a> 与 <a target="_blank" href="http://livescript.net/#cascades">cascade</a>，来减少巢状回调。它也让我们得以使用强大的语意工具，来自由组合函数式及对象导向的程序布局。</p>
<p>我对 LiveScript 的第一印象是“像是蕴含在 Perl 6 里的轻量语言，挣扎着想要诞生…” — 透过专注于语法的亲和力，并采用与 JavaScript 相同的语意，这个新语言想达成的目标，确实比 Perl 6 要容易多了。</p>
<h3>
<a name="-8" class="anchor" href="#-8"><span class="mini-icon mini-icon-link"></span></a>自由之零</h3>
<p>自由软件基金会持续倡导四大类的软件自由。其中最基本的一种，称为“自由之零”，就是“无论为任何目的，都能执行程序的自由”。</p>
<p>在二十世纪，开源软件及私有软件都赋予使用者这种自由。我们太习惯这种自由，以致认为它理所当然，直到“云计算”出现为止。</p>
<p>将资料托管在共享的服务器上，并不是什么新的概念。远端存储服务的历史，几乎跟互联网一样悠久，而在持续进步的传输与加密技术防范资料遗失及窜改下，它们通常也都能顺利运作。</p>
<p>但是到了这个世纪，远端存储逐渐与远端计算及通信挂勾。一旦我们将计算交给远端的服务器，便再也不可能“为任何目的执行程序”了。取而代之的情况，是服务运营者独占了计算的内容，并拥有不受监管而能检视、审查使用者资料的权力。</p>
<p>因此，在“日常倚赖的程序都应该能取得源代码”这个众所周知的理念之外，“只将资料交给我们能信任的服务器进行计算”也是同等重要。为了达成这个目的，我将 EtherCalc 设计成可以轻易安装，因此它永远都能在您自己的电脑上运作。</p>
<p>Socialtext 为了 SocialCalc 电子表格的引擎，特别制定了<a target="_blank" href="https://www.socialtext.net/open/cpal">通用公共授权</a>，让使用者可以向服务运营者要求完整的 JavaScript 源代码，来鼓励服务运营商将他们所做的修改贡献出来。</p>
<p>至于 EtherCalc 这套多人协作服务器，笔者已将它捐入<a target="_blank" href="http://creativecommons.org/publicdomain/zero/1.0">公众领域</a>，让它可以整合进各式内容管理系统里。如此一来，任何人都能轻易为自己的团队架设一套电子表格协作系统。很多人已经这样做了，也非常欢迎您的加入！</p>
</section>
<img src="ethercalc.tw.signature.png" alt="唐鳳 Audrey Tang" style="max-width:34%; margin-top: 50px; margin-left: 33%" width="50%">
<p style="text-align: center; font-size: 12pt">（简体中文翻译：<a href="https://github.com/lyqscmy" target="_blank">李勇强</a>）

</p>
</div>
</div><div style="padding:20px 0;min-width:1028px;background-color:#EEEEEE"></div></center></body></html>
